/*
   使用说明
   1. 进入有风脉的地图会进行标记。
   2. 在游戏中新建宏，内容为：“/e 风脉”。（6.0的地图有10个地点但标记只有8个，需要切换8与2） 执行此宏，进行场景标记切换。
*/
if (new URLSearchParams(location.search).get("alerts") !== "0" && /raidboss\.html/.test(location.href)) {
  addOverlayListener("ChangeZone", handleChangeZone);
  addOverlayListener("LogLine", handleLogLine);

  const rawData = [
    { map: 397, x: 402.029, y: 191.536, z: 561.425 }, //库尔札斯西部高地
    { map: 397, x: 424.958, y: 164.308, z: -536.905 }, //库尔札斯西部高地
    { map: 397, x: -332.888, y: 126.844, z: -29.9522 }, //库尔札斯西部高地
    { map: 397, x: -660.144, y: 135.546, z: -376.63 }, //库尔札斯西部高地
    { map: 398, x: 765.011, y: -15.8518, z: 289.082 }, //龙堡参天高地
    { map: 398, x: 433.554, y: -47.7657, z: -286.244 }, //龙堡参天高地
    { map: 398, x: -480.278, y: -5.96861, z: -425.284 }, //龙堡参天高地
    { map: 398, x: 406.76, y: -89.7939, z: 686.61 }, //龙堡参天高地
    { map: 399, x: 729.228, y: 134.966, z: 150.908 }, //龙堡内陆低地
    { map: 399, x: 98.9095, y: 73.0938, z: -174.361 }, //龙堡内陆低地
    { map: 399, x: -487.471, y: 144.667, z: -285.335 }, //龙堡内陆低地
    { map: 399, x: -452.378, y: 138.125, z: 678.215 }, //龙堡内陆低地
    { map: 400, x: 421.164, y: -43.0586, z: 661.768 }, //翻云雾海
    { map: 400, x: -93.7944, y: -6.75406, z: 223.842 }, //翻云雾海
    { map: 400, x: -775.265, y: 123.763, z: 243.702 }, //翻云雾海
    { map: 400, x: 340.021, y: -25.3675, z: -130.535 }, //翻云雾海
    { map: 401, x: -747.097, y: -57.0979, z: 163.836 }, //阿巴拉提亚云海
    { map: 401, x: -759.426, y: -9.19702, z: -110.857 }, //阿巴拉提亚云海
    { map: 401, x: -180.315, y: -14.9159, z: -543.114 }, //阿巴拉提亚云海
    { map: 401, x: -564.813, y: -36.6847, z: -349.081 }, //阿巴拉提亚云海
    { map: 612, x: -487.266, y: 76.726, z: -249.561 }, //基拉巴尼亚边区
    { map: 612, x: 155.842, y: 53.3515, z: -499.431 }, //基拉巴尼亚边区
    { map: 612, x: 322.591, y: 88.9832, z: 10.5134 }, //基拉巴尼亚边区
    { map: 612, x: 743.033, y: 181.007, z: -214.052 }, //基拉巴尼亚边区
    { map: 620, x: 202.874, y: 133.925, z: -753.119 }, //基拉巴尼亚山区
    { map: 620, x: -271.229, y: 157.942, z: -280.232 }, //基拉巴尼亚山区
    { map: 620, x: -485.211, y: 304.469, z: 247.414 }, //基拉巴尼亚山区
    { map: 620, x: 146.627, y: 303.757, z: 460.821 }, //基拉巴尼亚山区
    { map: 621, x: -380.191, y: 10.0606, z: 16.9195 }, //基拉巴尼亚湖区
    { map: 621, x: 109.605, y: 42.0051, z: 788.632 }, //基拉巴尼亚湖区
    { map: 621, x: 261.534, y: 78.4, z: 69.9625 }, //基拉巴尼亚湖区
    { map: 621, x: 683.406, y: 70, z: 521.172 }, //基拉巴尼亚湖区
    { map: 613, x: 423.562, y: 15.8327, z: 801.565 }, //红玉海
    { map: 613, x: 21.2863, y: 24.0112, z: -623.621 }, //红玉海
    { map: 613, x: 694.769, y: 1.91278, z: -53.4642 }, //红玉海
    { map: 613, x: -805.781, y: 36.5798, z: 235.215 }, //红玉海
    { map: 614, x: 497.307, y: 16.362, z: 402.487 }, //延夏
    { map: 614, x: 163.583, y: 144.635, z: -11.9099 }, //延夏
    { map: 614, x: 457.511, y: 32.383, z: 822.415 }, //延夏
    { map: 614, x: -97.4191, y: 13.2794, z: 563.723 }, //延夏
    { map: 622, x: 570.277, y: -19.508, z: 438.175 }, //太阳神草原
    { map: 622, x: 232.005, y: 93.3919, z: -515.794 }, //太阳神草原
    { map: 622, x: 105.608, y: 116.043, z: -49.6987 }, //太阳神草原
    { map: 622, x: -693.83, y: 7.2632, z: 658.899 }, //太阳神草原
    { map: 813, x: 554.28, y: 17.9501, z: 352.102 }, //雷克兰德
    { map: 813, x: 613.245, y: 24.0201, z: -231.128 }, //雷克兰德
    { map: 813, x: -149.798, y: 15.2812, z: -102.495 }, //雷克兰德
    { map: 813, x: -619.637, y: 51.5011, z: -199.096 }, //雷克兰德
    { map: 814, x: 650.568, y: 0.354777, z: 556.39 }, //珂露西亚岛
    { map: 814, x: -651.165, y: 1.54972e-5, z: 588.412 }, //珂露西亚岛
    { map: 814, x: 623.752, y: 285.942, z: -555.25 }, //珂露西亚岛
    { map: 814, x: -62.8977, y: 345.125, z: -16.5333 }, //珂露西亚岛
    { map: 815, x: 446.079, y: -60.5523, z: -523.687 }, //安穆·艾兰
    { map: 815, x: 344.683, y: -66.53, z: 538.94 }, //安穆·艾兰
    { map: 815, x: -343.801, y: 46.9847, z: -235.432 }, //安穆·艾兰
    { map: 815, x: 158.804, y: -61.0948, z: 674.891 }, //安穆·艾兰
    { map: 816, x: -231.414, y: 4.70193, z: 160.844 }, //伊尔美格
    { map: 816, x: 12.8542, y: 110.753, z: -851.247 }, //伊尔美格
    { map: 816, x: 432.481, y: 90.4406, z: -770.4 }, //伊尔美格
    { map: 816, x: -8.99945, y: 89.3091, z: -247.64 }, //伊尔美格
    { map: 817, x: -405.955, y: 7.1691, z: 506.544 }, //拉凯提卡大森林
    { map: 817, x: -141.571, y: -0.88243, z: 49.7631 }, //拉凯提卡大森林
    { map: 817, x: 338.635, y: 24.1467, z: 203.184 }, //拉凯提卡大森林
    { map: 817, x: 681.139, y: -39.1963, z: -262.754 }, //拉凯提卡大森林
    { map: 818, x: 358.212, y: 396.552, z: -715.9 }, //黑风海
    { map: 818, x: 50.2051, y: 380.098, z: -512.073 }, //黑风海
    { map: 818, x: 339.116, y: 298.717, z: -280.016 }, //黑风海
    { map: 818, x: -774.229, y: 63.1922, z: -97.7103 }, //黑风海
    { map: 956, x: 346.529, y: 209.352, z: -767.739 }, //迷津
    { map: 956, x: 748.562, y: 106.712, z: 66.7589 }, //迷津
    { map: 956, x: -316.276, y: 79.7614, z: -395.312 }, //迷津
    { map: 956, x: 32.3334, y: 72.8314, z: -286.272 }, //迷津
    { map: 956, x: 497.115, y: 73.4197, z: -267.231 }, //迷津
    { map: 956, x: -547.726, y: -18.0226, z: 661.873 }, //迷津
    { map: 956, x: -128.069, y: -20.5234, z: 676.722 }, //迷津
    { map: 956, x: -176.381, y: -10.101, z: -242.245 }, //迷津
    { map: 956, x: -505.14, y: -21.8212, z: -122.596 }, //迷津
    { map: 956, x: 46.2823, y: -29.7999, z: 178.875 }, //迷津
    { map: 957, x: -176.104, y: 21.5304, z: 537.835 }, //萨维奈岛
    { map: 957, x: -49.2675, y: 94.0719, z: -710.757 }, //萨维奈岛
    { map: 957, x: 303.921, y: 0.280689, z: 473.656 }, //萨维奈岛
    { map: 957, x: -479.439, y: 72.9045, z: -561.809 }, //萨维奈岛
    { map: 957, x: -114.46, y: 87.0873, z: -288.29 }, //萨维奈岛
    { map: 957, x: 118.474, y: 4.9335, z: -343.866 }, //萨维奈岛
    { map: 957, x: 550.018, y: 25.4763, z: -159.076 }, //萨维奈岛
    { map: 957, x: 93.1188, y: 36.6839, z: -447.865 }, //萨维奈岛
    { map: 957, x: 294.402, y: 4.0999, z: 425.122 }, //萨维奈岛
    { map: 957, x: 53.1891, y: 11.3868, z: 187.406 }, //萨维奈岛
    { map: 958, x: -184.222, y: 31.9371, z: 423.606 }, //加雷马
    { map: 958, x: 194.816, y: -12.8414, z: 644.311 }, //加雷马
    { map: 958, x: 83.094, y: 1.52583, z: 102.017 }, //加雷马
    { map: 958, x: 405.295, y: -2.24316, z: 520.317 }, //加雷马
    { map: 958, x: -516.088, y: 42.4699, z: 67.8378 }, //加雷马
    { map: 958, x: 382.184, y: 25.9005, z: -482.196 }, //加雷马
    { map: 958, x: -602.03, y: 34.3171, z: -325.853 }, //加雷马
    { map: 958, x: 79.9136, y: 37.8851, z: -518.181 }, //加雷马
    { map: 958, x: 134.928, y: 14.3984, z: -172.249 }, //加雷马
    { map: 958, x: -144.924, y: 17.5785, z: -420.515 }, //加雷马
    { map: 959, x: 42.5905, y: 124.015, z: -167.03 }, //叹息海
    { map: 959, x: -482.744, y: -154.954, z: -595.709 }, //叹息海
    { map: 959, x: 316.401, y: -154.978, z: -595.519 }, //叹息海
    { map: 959, x: 29.1046, y: -47.739, z: -550.408 }, //叹息海
    { map: 959, x: -128.002, y: 66.3504, z: -68.2408 }, //叹息海
    { map: 959, x: 591.378, y: 149.356, z: 114.936 }, //叹息海
    { map: 959, x: 388.358, y: 99.9167, z: 306.071 }, //叹息海
    { map: 959, x: 652.979, y: -160.693, z: -405.081 }, //叹息海
    { map: 959, x: -733.617, y: -139.662, z: -733.28 }, //叹息海
    { map: 959, x: 21.7081, y: -133.5, z: -385.731 }, //叹息海
    { map: 961, x: 628.239, y: 8.31683, z: 107.902 }, //厄尔庇斯
    { map: 961, x: -754.753, y: -36.0114, z: 411.134 }, //厄尔庇斯
    { map: 961, x: 151.667, y: 7.66582, z: 2.548 }, //厄尔庇斯
    { map: 961, x: -144.539, y: -26.2298, z: 551.52 }, //厄尔庇斯
    { map: 961, x: -481.407, y: -28.5802, z: 490.562 }, //厄尔庇斯
    { map: 961, x: -402.921, y: 327.757, z: -691.323 }, //厄尔庇斯
    { map: 961, x: -555.623, y: 158.118, z: 172.429 }, //厄尔庇斯
    { map: 961, x: -392.05, y: 173.724, z: -293.599 }, //厄尔庇斯
    { map: 961, x: -761.711, y: 160.011, z: -108.987 }, //厄尔庇斯
    { map: 961, x: -255.512, y: 143.079, z: -36.9727 }, //厄尔庇斯
    { map: 960, x: -333.54, y: 270.851, z: -361.487 }, //天外天垓
    { map: 960, x: 13.118, y: 275.566, z: -756.396 }, //天外天垓
    { map: 960, x: 661.785, y: 439.977, z: 411.757 }, //天外天垓
    { map: 960, x: 539.271, y: 438.001, z: 239.404 }, //天外天垓
    { map: 960, x: 424.573, y: 283.384, z: -679.755 }, //天外天垓
    { map: 960, x: -238.789, y: 320.386, z: -295.141 }, //天外天垓
    { map: 960, x: -385.221, y: 262.517, z: -629.85 }, //天外天垓
    { map: 960, x: 751.878, y: 439.977, z: 357.899 }, //天外天垓
    { map: 960, x: 637.195, y: 439.241, z: 289.665 }, //天外天垓
    { map: 960, x: 567.498, y: 440.93, z: 402.135 }, //天外天垓
  ];

  const data = (() => {
    let result = {};
    for (const key in rawData) {
      const obj = rawData[key];
      if (!result[obj.map]) result[obj.map] = [];
      result[obj.map].push({ ...obj });
    }
    return result;
  })();

  const waymarkTypes = ["A", "B", "C", "D", "One", "Two", "Three", "Four"];
  let marks = [];
  let remainder = [];
  let flag = false;

  function handleChangeZone(e) {
    marks = data[e.zoneID] ?? [];
    remainder = marks.slice(waymarkTypes.length);
    flag = false;
    if (marks.length > 0) doWaymark();
  }

  function handleLogLine(e) {
    if (e.line[0] === "00" && e.line[2] === "0038" && e.line[4] === "风脉") {
      doWaymark();
    }
  }

  function doWaymark() {
    callOverlayHandler({
      call: "PostNamazu",
      c: "place",
      p: JSON.stringify(formatWaymarks((flag = !flag) ? marks : remainder)),
    });
  }

  function formatWaymarks(marks) {
    let waymark = {};
    for (let i = 0; i < waymarkTypes.length; i++) {
      waymark[waymarkTypes[i]] = {
        X: marks[i]?.x ?? 0,
        Y: marks[i]?.y ?? 0,
        Z: marks[i]?.z ?? 0,
        Active: !!marks[i],
      };
    }
    return waymark;
  }
}
